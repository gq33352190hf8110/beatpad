<html>

<head>
  <!-- Load @magenta/music -->
  
  <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.0.0"></script>
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.1.19/Tone.min.js"></script>
  <link rel="stylesheet" href="index.css">
</head>
  <header>
    Header
  </header>
  <main>
    <div id="soundboard">
      <div id="beat"></div>
      <div id="instruments">
        <!-- Eventually will be a moving line corresponding to position -->
      <!-- <div id="line"></div> -->
      </div>
  </main>
  <aside>
    <input id="search" type="text">
    <button id="play">Button</button>
    <ul>
      <li>Sound 1</li>
      <li>Sound 2</li>
      <li>Sound 3</li>
    </ul>
  </aside>
  <footer>
    Footer
  </footer>
  <audio data-key="1" src="sounds/boom.wav"></audio>
  <script>

    const render = function (template, node) {
      if (!node) return;
      node.innerHTML = (typeof template === 'function' ? template() : template);
      var event = new CustomEvent('elementRenders', {
        bubbles: true
      });
      node.dispatchEvent(event);
      return node;
    };
    document.addEventListener('elementRendered', function (event) {
      var elem = event.target;
    }, false);

  </script>
  <script>
    
    const state = {}
    
    
    //CREATING INTERVAL FUNCTIONS AND ONCLICK HANDLERS

    function noteClick (e) {
      let instruments = state.instruments
      instruments.forEach((instrument, instrumentIndex) => {
        instrument.notes.forEach((noteBoolean, noteIndex) => {
          if (instrument.id + '-' + noteIndex === e.target.id) {
            let note = document.getElementById(instrument.id + "-" + noteIndex);
            note.style.backgroundColor = !noteBoolean ? '#6500a0' : '#ffcccc';
            instruments[instrumentIndex].notes[noteIndex] = !instruments[instrumentIndex].notes[noteIndex]
            state.instruments = instruments
          }
        })
      })
    };
    
    //This function will likely be removed/changed with full introduction of Tone.js
    let beat = () => {
      state.instruments.forEach(instrument => {
        instrument.notes.forEach((noteBoolean,noteIndex) => {
          if (!noteBoolean || state.beatNumber != noteIndex) return;
          let note = document.getElementById(instrument.id + "-" + noteIndex);
          const audio = document.querySelector(`audio[data-key="1"]`);
          note.style.backgroundColor = 'black';
          audio.currentTime = 0;
          audio.play();
          //TODO: Add event listener instead of timeout
          setTimeout(() => {
            note.style.backgroundColor = '#6500a0';
          }, 200)
        })
        let template = '<h1>The beat is ' + state.beatNumber 
        render(template, document.querySelector('#beat'));
      })
        state.beatNumber === 15 ? state.beatNumber = 0 : state.beatNumber += 1 ;
    };


    let initiateState = () => {
      return new Promise((resolve, reject) => {
        let falseTimes16Array = () => {
          return "false ".repeat(15).split(" ").map(each => each === "true")
        }
        state.instruments = [
          {name: "synth", id: 0, type:"tonejs", note: new Tone.AMSynth().toMaster(), notes: falseTimes16Array()},
          {name: "synth", id: 1, type:"tonejs", note: new Tone.AMSynth().toMaster(), notes: falseTimes16Array()},
        ]
        state.beatNumber = 0
        resolve();
      })
    }


    let addInstruments = () => {
      return new Promise((resolve, reject) => {
        console.log('state',state)
        
        state.instruments.forEach(each => {
          let instrument = document.createElement("div")
          instrument.id = each.id
          instrument.setAttribute("style", "display: grid; grid-template-columns: repeat(16, 1fr); grid-gap: 5px; height: 50px;")
          for (let noteID = 0; noteID < 16; noteID++) {
            let note = document.createElement("div");
            note.id = each.id + "-" + noteID
            note.style.border = '2px solid black';
            note.style.backgroundColor = '#ffcccc';
            instrument.appendChild(note)
          }
          instruments.appendChild(instrument)
        })
        
        render(instruments.innerHTML, document.querySelector('#instruments'));
        
        resolve();
      })
    }
    
    let addEventListeners = () => {
      return new Promise((resolve, reject) => {
        state.instruments.forEach(each => {
          for (let noteID = 0; noteID < 16; noteID++) {
            let note = document.getElementById(each.id + "-" + noteID)
            note.addEventListener('click', noteClick)
          }
        })
        
        
        const search = document.getElementById("search")
        search.addEventListener('keyup', (e) => {
          if (event.key == "Enter") {
            console.log('Entered')
            console.log(search.value)
          }
        })


        let triggerSynth = (time) => {
          //the time is the sample-accurate time of the event
          let synth = state.instruments[0].note
          synth.triggerAttackRelease('C2', '8n', time)
        }

        let playButton = document.getElementById("play")
        playButton.addEventListener("click", (e) => {
          Tone.Transport.stop()
          let synth = state.instruments[0].note
          Tone.Transport.bpm.value = 120
          state.instruments.forEach((instrument, instrumentIndex) => {
            instrument.notes.forEach((note, noteIndex) => {
              if (note) {
                Tone.Transport.schedule(triggerSynth, '0:'+(noteIndex+1))
              }
            })
          })
          Tone.Transport.start('+0.1')
        })

        resolve();
      })
    }



    initiateState()
      .then(() => addInstruments()
        .then(() => addEventListeners()
          .then(() => console.log("asdasds"))
      ))









    //Magenta MusicVAE
    // const model = new mm.MusicVAE(
    //   'https://storage.googleapis.com/download.magenta.tensorflow.org' +
    //   '/tfjs_checkpoints/music_vae/trio_4bar');
    // const player = new mm.Player();
    
    // function play() {
    //   mm.Player.tone.context.resume();  // enable audio
    //   model.sample(1)
    //   .then((samples) => player.start(samples[0], 80));
    // }
    // play();


    // let sampleBaseUrl = 'https://s3-us-west-2.amazonaws.com/s.cdpn.io/969699';
    
    // let kick = new Tone.Player({
    //   "url": `${sampleBaseUrl}/808-kick-vm.mp3`,
    //   "autostart": true
    // }).toMaster();



    //Start main interval functions
    // beat();
    // window.setInterval(beat, 200);
  </script>
</html>







