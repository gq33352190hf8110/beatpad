<html>

<head>
  <!-- Load @magenta/music -->
  
  <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.0.0"></script>
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.1.19/Tone.min.js"></script>
  <link rel="stylesheet" href="index.css">
</head>
  <header>
    Header
  </header>
  <main>
    <div id="soundboard">
      <div id="beat"></div>
      <div id="instruments">
        <!-- Eventually will be a moving line corresponding to position -->
      <!-- <div id="line"></div> -->
      </div>
  </main>
  <aside>
    <!-- <input id="search" type="text"> -->
    <button id="play">Play</button>
    <ul>
      <li><button data-type="instrument" data-source="tonejs" data-note="new Tone.AMSynth().toMaster()" data-name="synth">Synth</button></li>
      <li><button data-type="instrument" data-source="other" data-note='new Tone.Player("https://s3-us-west-2.amazonaws.com/s.cdpn.io/969699/808-kick-vh.mp3").toMaster()' data-name="kick">Kick</button></li>
      <li><button data-type="instrument" data-source="other" data-note='new Tone.Player("https://s3-us-west-2.amazonaws.com/s.cdpn.io/969699/flares-snare-vm.mp3").toMaster()' data-name="snare">Snare</button></li>
    </ul>
  </aside>
  <footer>
    Footer
  </footer>
  <audio data-key="1" src="sounds/boom.wav"></audio>
  <script>

    const render = function (template, node) {
      if (!node) return;
      node.innerHTML = (typeof template === 'function' ? template() : template);
      var event = new CustomEvent('elementRenders', {
        bubbles: true
      });
      node.dispatchEvent(event);
      return node;
    };
    document.addEventListener('elementRendered', function (event) {
      var elem = event.target;
    }, false);

  </script>
  <script>
    
    const state = {
      instruments: [],
      beatNumber: 0,
      currentID: 0
    }
    
    
    //CREATING INTERVAL FUNCTIONS AND ONCLICK HANDLERS

    falseTimes16Array = () => {
      return "false ".repeat(15).split(" ").map(each => each === "true")
    }
    falseTimes32Array = () => {
      return "false ".repeat(31).split(" ").map(each => each === "true")
    }

    (addPlayListener = () => {
      console.log('adding')
      let playButton = document.getElementById("play")
        playButton.addEventListener("click", (e) => {
          console.log('playing')          
          Tone.Transport.cancel()
          Tone.Transport.stop()
          Tone.Transport.bpm.value = 120
          state.instruments.forEach((instrument, instrumentIndex) => {
            instrument.notes.forEach((note, noteIndex) => {
              if (note) {
                Tone.Transport.schedule((time) => {
                  console.log(time)
                  if (instrument.source === 'tonejs') {
                    instrument.note.triggerAttackRelease('C2', '8n', time)
                  } else {
                    console.log(instrument.note)
                    instrument.note.start();
                  }
                }, '0:0:'+(noteIndex))
              }
            })
          })
          Tone.Transport.start('+0.1')
        })
    })();
    

    function noteClick (e) {
      console.log(e.target)
      let instruments = state.instruments
      instruments.forEach((instrument, instrumentIndex) => {
        instrument.notes.forEach((noteBoolean, noteIndex) => {
          if (instrument.id + '-' + noteIndex === e.target.id) {
            let note = document.getElementById(instrument.id + "-" + noteIndex);
            note.style.backgroundColor = !noteBoolean ? '#6500a0' : 'transparent';
            instruments[instrumentIndex].notes[noteIndex] = !instruments[instrumentIndex].notes[noteIndex]
            state.instruments = instruments
          }
        })
      })
    };

    renderInstrument = (id, name) => {
      let instruments = document.querySelector('#instruments')
      let instrument = document.createElement("div")
      instrument.id = id
      instrument.setAttribute("style", "display: grid; grid-template-columns: repeat(34, 1fr); grid-gap: 5px; height: 50px;")
      let p = document.createElement("p")
      p.innerHTML = name;
      p.style.minWidth = "40px";
      instrument.appendChild(p)
      for (let noteID = 0; noteID < 32; noteID++) {
        let note = document.createElement("div");
        note.id = id + "-" + noteID
        note.style.border = '2px solid black';
        note.addEventListener('click', noteClick)
        instrument.appendChild(note)
      }
      let button = document.createElement("button");
      button.innerHTML = "X"
      button.dataset.type = "remove"
      button.dataset.id = id
      button.addEventListener('click', (e) => {
        let deletedID = state.instruments.findIndex(instrument => instrument.id === parseInt(e.target.dataset.id))
        let toDelete = document.querySelector(`div[id="${deletedID}"]`)
        instruments.removeChild(toDelete)
      })
      instrument.appendChild(button)
      instruments.appendChild(instrument)
    }

    addInstrumentListener = () => {
      let buttons = document.querySelectorAll(`button[data-type=instrument]`)
      let instruments = document.querySelector('#instruments')
      buttons.forEach((button) => {
        button.addEventListener('click', (e) => {
          state.instruments.push({name: e.target.dataset.name, id: state.currentID, source:e.target.dataset.source, note: eval(e.target.dataset.note), notes: falseTimes32Array()})
          renderInstrument(state.currentID, e.target.dataset.name)
          state.currentID++
        })
      })
    }
    addInstrumentListener();

  </script>
</html>







